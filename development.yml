---
version: '3'
services:
  riff-server:
    image: 127.0.0.1:5000/riff-server
    build: 
      context: ../riff-server
      args:
        - AUTH_ON=true
        - AUTH_TOKEN_EXPIRESIN=1000d
        - AUTH_TOKEN_SECRET=my-secret
        - CRYPTO_KEY="'your-key-here'"
        - DEFAULT_USER_EMAIL=default-user-email
        - DEFAULT_USER_PASSWORD=default-user-password
        - MONGODB_URI=mongodb://mongo-server/riff-test
        - MONGO_CERT=some-fake-cert
        - NODE_ENV=default
        - PORT=3000
        - REPORT_EMAIL_FROM="'MM Reports' <email@address.com>"
        - REPORT_EMAIL_HOST="smtp server here"
        - REPORT_EMAIL_LOGIN=email@address.com
        - REPORT_EMAIL_PASSWORD=emailpassword
        - REPORT_EMAIL_SUBJECT="Your Group Discussion Report"
        - REPORT_EMAIL_TEXT="See attached for a visual report of your recent group discussion!"
        - SEND_REPORT=false
        - END_MEETING_AFTER_MINUTES=2
    ports:
      - '3000'
    depends_on:
      - mongo-server

  riff-rtc:
    image: 127.0.0.1:5000/riff-rtc
    build:
      context: ../riff-rtc
      dockerfile: Dockerfile-dev
      args:
        - REACT_APP_DEBUG=true
        - CI=false
        - NODE_ENV=development
        - DATASERVER_EMAIL=default-user-email
        - DATASERVER_PASSWORD=default-user-password
        - SESSION_SECRET=secret
        - CONSUMER_SECRET=key
        - CONSUMER_SECRET=secret
    ports:
      - '3001'
    depends_on:
      - riff-server
    volumes:
      - ../riff-rtc/:/app/

  mongo-server:
    image: mongo:latest
    volumes:
      - db-data:/data/db

  signalmaster:
    build: https://github.com/andyet/signalmaster.git
    image: 127.0.0.1:5000/signalmaster
    ports:
      - "8888"
    environment:
      - STUNSERVER_URL=stun:stun.services.mozilla.com

  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - "8080:8080"
    stop_grace_period: 1m30s
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"

  web-server:
    image: 127.0.0.1:5000/web-server
    build: web-server
    ports:
      - '80:80'
    depends_on:
      - riff-rtc
      - riff-server

volumes:
  db-data:
